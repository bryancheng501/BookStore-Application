var username
var password

/*
Index functions:
    createAccount()
    logIn()
*/

function createAccount(){
    username = document.getElementById('username').value
    password = document.getElementById('password').value

    if (!username || !password){
        alert("Please input a username and password!")
        return;
    }

    let req = new XMLHttpRequest()
    req.onreadystatechange = function(){
        if (this.readyState==4 && this.status == 200){
            alert(this.responseText);
        }
    }
    req.open('POST', '/createAccount')
    req.setRequestHeader('Content-type', 'application/json')
    req.send(JSON.stringify({'username' : username, 'password' : password}))

}

/*
logging in - not using for now

function logIn(){
    username = document.getElementById('username').value
    password = document.getElementById('password').value

    if (!username || !password){
        alert("Please input a username and password!")
        return;
    }

    let req = new XMLHttpRequest()
    req.onreadystatechange = function(){
        if (this.readyState==4 && this.status == 200){
            response = JSON.parse(this.responseText)
            if (response.loggedIn){
                alert('Succesfully logged in!')
                //redirect them based on account type
                if (response.type == 'customer'){
                    window.location.href = "/customerPage"
                }
            }   else{
                alert('Invalid username and/or password!')
            }
        }
    }
    req.open('POST', '/logIn')
    req.setRequestHeader('Content-type', 'application/json')
    req.send(JSON.stringify({'username' : username, 'password' : password}))
}
*/

/*
Customer Page

*/

//Search for books
function search(){
    let searchQuery = document.getElementById('search').value
    let searchType = document.getElementById('searchType').options[document.getElementById('searchType').selectedIndex].value
    let genre = document.getElementById('genre').options[document.getElementById('genre').selectedIndex].value

    if (!searchQuery){
        alert("Please enter a search query!")
        return
    }

    let req = new XMLHttpRequest()
    req.onreadystatechange = function(){
        if (this.readyState==4 && this.status == 200){
            response = JSON.parse(this.responseText)
            loadBooks(response)
        }
    }

    let reqHeader = '/searchBooks/' + searchQuery + '/' + searchType
    if (genre){
        reqHeader += ('/' + genre)
    }

    req.open('GET', reqHeader)
    req.send()
}

//add questions to checkout
function checkoutBooks(){
    username = document.getElementById('username').value
    password = document.getElementById('password').value

    if (!username || !password){
        alert("Please input a username and password!")
        return
    }

    let cb = document.getElementsByClassName('booksToAdd')
    let books = []
    //find books that were checked off
    for (let i = 0; i < cb.length; i++){
        if (cb[i].checked){
            books.push(cb[i].id)
        }
    }

    if (books.length == 0){
        alert("Please select some books")
        return
    }

    let req = new XMLHttpRequest()
    req.onreadystatechange = function(){
        if (this.readyState==4 && this.status == 200){
            let response = JSON.parse(this.responseText)
            if (!response.loggedIn){
                alert('Invalid username and password')
                return
            }

            if (response.success){
                alert('Books successfully added to checkout basket')
            }
        }
    }

    req.open('POST', '/checkoutBooks')
    req.setRequestHeader('Content-type', 'application/json')
    req.send(JSON.stringify({'books': books, 'username' : username, 'password' : password}))
}

//load books generated by search
function loadBooks(books){
    let booksDiv = document.getElementById('books')
    booksDiv.innerHTML = ""

    //add a button for users to checkout selected book
    let checkoutBooks = document.getElementById('checkoutBooks')
    if (books.length > 0){
        document.getElementById('checkoutDiv').style.display = 'block'
    }   else{
        document.getElementById('checkoutDiv').style.display = 'none'
    }

    //Display books generated by search
    for (let i = 0; i < books.length; i++){
        //make html for all the book info
        let title = document.createElement('label')
        title.style.fontSize = 'larger'
        title.innerHTML = '<br>' + books[i].title + '<br>'
    
        let bookInfo = document.createElement('label')
        bookInfo.innerHTML += books[i].num_pages + ' pages<br>' + books[i].author + '<br>'
        bookInfo.innerHTML += books[i].publisher_name + '<br>' + books[i].genre + '<br>' + books[i].isbn
        bookInfo.innerHTML += '<br>$' + books[i].price + '<br><br><br>'

        //creating checkboxes to add books to checkout cart
        let cb = document.createElement('input')
        cb.type = 'checkbox'
        cb.className = 'booksToAdd'
        cb.id = books[i].isbn

        //adding to HTML
        booksDiv.appendChild(cb)
        booksDiv.appendChild(title)
        booksDiv.appendChild(bookInfo)
    }
}

//View checked out items
function reviewOrder(){
    let username = document.getElementById('username').value
    let password = document.getElementById('password').value

    if (!username || !password){
        alert("Please input a username and password!")
        return
    }

    let req = new XMLHttpRequest()
    req.onreadystatechange = function(){
        if (this.readyState==4 && this.status == 200){
            let response = JSON.parse(this.responseText)
            if (!response.loggedIn){
                alert('Invalid username and password')
                return
            } 
        }
    }

    let reqHeader = '/reviewOrder/' + username + '/' + password
    req.open('GET', reqHeader)
    req.send()
}


function placeOrder(){
    let username = document.getElementById('username').value
    let password = document.getElementById('password').value
    let sAddress = document.getElementById('sAddress').value
    let bAddress = document.getElementById('bAddress').value

    if (!username || !password || sAddress || bAddress){
        alert("Please enter a username, password, and billing information")
        return
    }

    let req = new XMLHttpRequest()
    req.onreadystatechange = function(){
        if (this.readyState==4 && this.status == 200){
            let response = JSON.parse(this.responseText)
            if (!response.loggedIn){
                alert("Invalid username/password")
                return
            }
        }
    }

    let myObj = {
        'username' : username,
        'password' : password,
        'sAddress' : sAddress,
        'bAddress' : bAddress
    }

    req.open('POST', '/placeOrder')
    req.setRequestHeader('Content-type', 'application/json')
    req.send(JSON.stringify(myObj))
}

